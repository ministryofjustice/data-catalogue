name: DataHub Post Ingestion Validation Checks

permissions:
  id-token: write
  contents: read

on:
  workflow_dispatch:
  pull_request:
  push:
    branches:
      - main

jobs:
  run-for-preprod:
    runs-on: ubuntu-latest
    environment: preprod-ingestion
    outputs:
      preprod_counts: ${{ steps.set_preprod_counts.outputs.preprod_results }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - uses: snok/install-poetry@v1
        with:
          version: 1.7.1
          virtualenvs-create: true
          virtualenvs-in-project: true

      - run: poetry install --no-interaction --no-root

      - name: Query preprod datahub for counts
        env:
          DATAHUB_GMS_TOKEN: ${{ secrets.DATAHUB_GMS_TOKEN }}
          DATAHUB_GMS_URL: ${{ vars.DATAHUB_GMS_URL }}
          PYTHONPATH: ${{ github.workspace }}
        id: set_preprod_counts
        run: |
          poetry run python ingestion/post_ingestion_checks.py counts --env preprod \
          --platforms dbt glue justice-data GOV.UK


  run-for-prod:
    runs-on: ubuntu-latest
    environment: prod-ingestion
    needs: run-for-preprod
    outputs:
      prod_counts: ${{ steps.set_prod_counts.outputs.prod_results }}
      missing_is_part_of: ${{ steps.set_relations.outputs.missing_is_part_of }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - uses: snok/install-poetry@v1
        with:
          version: 1.7.1
          virtualenvs-create: true
          virtualenvs-in-project: true

      - run: poetry install --no-interaction --no-root
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.CADET_METADATA_ROLE_TO_ASSUME }}
          role-duration-seconds: 14400
          aws-region: eu-west-1

      - name: Query prod datahub for counts
        env:
          DATAHUB_GMS_TOKEN: ${{ secrets.DATAHUB_GMS_TOKEN }}
          DATAHUB_GMS_URL: ${{ vars.DATAHUB_GMS_URL }}
          PYTHONPATH: ${{ github.workspace }}
        id: set_prod_counts
        run: |
          poetry run python ingestion/post_ingestion_checks.py counts --env prod \
          --platforms dbt glue justice-data GOV.UK

      - name: check datasets' IsPartOf relations
        env:
          DATAHUB_GMS_TOKEN: ${{ secrets.DATAHUB_GMS_TOKEN }}
          DATAHUB_GMS_URL: ${{ vars.DATAHUB_GMS_URL }}
          PYTHONPATH: ${{ github.workspace }}
        id: set_relations
        run: |
          poetry run python ingestion/post_ingestion_checks.py relations --env prod \
          --s3-manifest-path "s3://mojap-derived-tables/prod/run_artefacts/latest/target/manifest.json"


  compare_results:
    runs-on: ubuntu-latest
    outputs:
      comparison_results: ${{ steps.compare_results.outputs.comparison_results }}
    environment: prod-ingestion
    needs: [run-for-preprod, run-for-prod]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - uses: snok/install-poetry@v1
        with:
          version: 1.7.1
          virtualenvs-create: true
          virtualenvs-in-project: true

      - run: poetry install --no-interaction --no-root
      - name: Compare results
        env:
          PYTHONPATH: ${{ github.workspace }}
        id: compare_results
        run: |
          poetry run python ingestion/post_ingestion_checks.py compare \
          --platforms dbt glue justice-data GOV.UK \
          --prod-results '${{ needs.run-for-prod.outputs.prod_counts }}' \
          --preprod-results '${{ needs.run-for-preprod.outputs.preprod_counts }}'

  post_ingestion_checks_report:
    runs-on: ubuntu-latest
    environment: prod-ingestion
    needs: [run-for-prod, compare_results]
    steps:
      - uses: actions/checkout@v4
      - name: Report datasets with missing container relationships
        run: |
          echo 'Missing IsPartOf relations: ${{ needs.run-for-prod.outputs.missing_is_part_of }}'
      - name: Report on prod vs preprod comparison results
        run: |
          echo 'Comparison results: ${{ needs.compare_results.outputs.comparison_results }}'
